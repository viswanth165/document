{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "VpcId": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "Enter the vpc ID"
        },
        "subneteks": {
            "Type": "List<AWS::EC2::Subnet::Id>",
            "Description": "Select the VPC under the selected VPC"
        },
        "Name": {
            "Type": "String",
            "Description": "Enter the Name"
        },
        "Imageid": {
            "Type": "String",
            "Description": "AMI id"
        },
        "Owner": {
            "Type": "String",
            "Description": "Enter the Owner"
        },
        "Project": {
            "Type": "String",
            "Description": "Enter the Project"
        },
        "Application": {
            "Type": "String",
            "Description": "Enter the Application"
        },
        "Environment": {
            "Type": "String",
            "Description": "Enter the Environment"
        },
        "SecondaryOwner": {
            "Type": "String",
            "Description": "Enter the SecondaryOwner"
        },
        "SecretManagerName": {
            "Type": "String",
            "Description": "Enter the SecretManager"
        },
        "EKSsgProtocol": {
            "Type": "String",
            "Description": "Enter the EKS security group protocol to allow"
        },
        "EKSsgFromport": {
            "Type": "Number",
            "Description": "Enter the EKS security group fromport to allow"
        },
        "EKSsgToport": {
            "Type": "Number",
            "Description": "Enter the EKS security group toport to allow"
        },
        "EKSsgCIDR": {
            "Type": "String",
            "Description": "Enter the EKS security group cidr range to allow"
        },
        "EKSversion": {
            "Type": "String",
            "Description": "Enter the EKS version"
        },
        "EndpointPublicAccess": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false",
            "Description": "Select the cluster to be public"
        },
        "EndpointPrivateAccess": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "Select the cluster to be private"
        },
        "NGCapacityType": {
            "Type": "String",
            "Description": "Enter the Nodegroup CapacityType"
        },
        "NGMinSize": {
            "Type": "Number",
            "Description": "Enter the minimum number of nodes in node group"
        },
        "NGDesiredSize": {
            "Type": "Number",
            "Description": "Enter the desired number of nodes in node group"
        },
        "NGMaxSize": {
            "Type": "Number",
            "Description": "Enter the maxmium number of nodes in node group"
        },
        "NGInstanceTypes": {
            "Type": "List<String>",
            "Description": "Enter the instance type of node"
        },
        "TemplateVolumeSize": {
            "Type": "Number",
            "Description": "Enter the Volume size"
        },
        "TemplateVolumeType": {
            "Type": "String",
            "Description": "Enter the Volume type"
        },
        "TemplateDeviceName": {
            "Type": "String",
            "Description": "Enter the template device name"
        },
        "DBsgFromport": {
            "Type": "Number",
            "Description": "Enter the DB security group fromport"
        },
        "DBsgToport": {
            "Type": "Number",
            "Description": "Enter the DB security group toport"
        },
        "DBsgProtocol": {
            "Type": "String",
            "Description": "Enter the DB security group protocol"
        },
        "DBsgCIDR": {
            "Type": "String",
            "Description": "Enter the DB security group cidr range"
        },
        "DBAllocatedStorage": {
            "Type": "Number",
            "Description": "Enter the AllocatedStorage"
        },
        "DBInstanceClass": {
            "Type": "String",
            "Description": "Enter the DB instance class"
        },
        "DBEngine": {
            "Type": "String",
            "Description": "Enter the DB engine"
        },
        "DBEngineVersion": {
            "Type": "String",
            "Description": "Enter the DB engine version"
        },
        "DBMasterUsername": {
            "Type": "String",
            "Description": "Enter the DB username"
        },
        "DBSubnetGroupName": {
            "Type": "String",
            "Description": "Enter the Subnetgroup name"
        },
        "DBKmsKeyId": {
            "Type": "String",
            "Description": "Enter the KMS key id"
        },
        "DBBackupRetentionPeriod": {
            "Type": "Number",
            "Description": "Enter the backup retention period"
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "da3dda13-6525-4ba2-924a-d234f3b30f23": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 100,
                    "y": 400
                },
                "z": 1,
                "embeds": []
            },
            "8781427f-b8bf-450c-8599-e5dd1f0a075e": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -80,
                    "y": 290
                },
                "z": 1,
                "embeds": []
            },
            "6d973b60-12a0-4f91-a14e-ca9a92e718b3": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -80,
                    "y": 180
                },
                "z": 1,
                "embeds": []
            },
            "452dd6c1-e667-4127-9b56-1a72f4562630": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 100,
                    "y": 270
                },
                "z": 1,
                "embeds": []
            },
            "3b9ca79b-ce3c-4ec3-a149-cecf0005bf79": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -80,
                    "y": 400
                },
                "z": 1,
                "embeds": []
            },
            "8c966e8a-4636-47d1-80f1-b7a9e928c244": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -80,
                    "y": 500
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "3b9ca79b-ce3c-4ec3-a149-cecf0005bf79"
                ]
            },
            "af29e948-a0c3-450a-aaf2-a491926ed7e7": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -190,
                    "y": 400
                },
                "z": 1,
                "embeds": []
            },
            "034fd1ef-250c-489c-bd69-432ed78ed620": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 250,
                    "y": 520
                },
                "z": 1,
                "embeds": []
            },
            "f816e465-faad-4a19-857d-e20a74fd47b2": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 250,
                    "y": 400
                },
                "z": 1,
                "embeds": []
            },
            "5351e1e1-51f6-47da-83c9-7a8f52a4033b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 250,
                    "y": 280
                },
                "z": 1,
                "embeds": []
            },
            "45eea9cd-fb65-4460-95e2-fe22dd44fda1": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 390,
                    "y": 400
                },
                "z": 1,
                "embeds": []
            }
        }
    },
    "Resources": {
        "EKS": {
            "Type": "AWS::EKS::Cluster",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks"
                        ]
                    ]
                },
                "Version": {
                    "Ref": "EKSversion"
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "demo",
                        "Arn"
                    ]
                },
                "ResourcesVpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "sgeks"
                        }
                    ],
                    "SubnetIds": {
                        "Ref": "subneteks"
                    },
                    "EndpointPublicAccess": {
                        "Ref": "EndpointPublicAccess"
                    },
                    "EndpointPrivateAccess": {
                        "Ref": "EndpointPrivateAccess"
                    }
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-eks"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "da3dda13-6525-4ba2-924a-d234f3b30f23"
                }
            }
        },
        "demo": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks-role"
                        ]
                    ]
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "eks.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-eks-role"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8781427f-b8bf-450c-8599-e5dd1f0a075e"
                }
            }
        },
        "BDSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "   ": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-db-sg"
                        ]
                    ]
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-db-sg"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "VpcId"
                },
                "GroupDescription": "DB security group",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": {
                            "Ref": "DBsgProtocol"
                        },
                        "FromPort": {
                            "Ref": "DBsgFromport"
                        },
                        "ToPort": {
                            "Ref": "DBsgToport"
                        },
                        "CidrIp": {
                            "Ref": "DBsgCIDR"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": 0,
                        "ToPort": 0,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "5351e1e1-51f6-47da-83c9-7a8f52a4033b"
                }
            }
        },
        "SecretManager": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Ref": "SecretManagerName"
                },
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"{{username}}\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 10
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-db-sm"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "034fd1ef-250c-489c-bd69-432ed78ed620"
                }
            }
        },
        "DBparametergroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "DBParameterGroupName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-db-pg"
                        ]
                    ]
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-db-pg"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ],
                "Family": "postgres"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "45eea9cd-fb65-4460-95e2-fe22dd44fda1"
                }
            }
        },
        "RDSDBI2QFNJ": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "rds"
                        ]
                    ]
                },
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "AllocatedStorage": {
                    "Ref": "DBAllocatedStorage"
                },
                "Engine": {
                    "Ref": "DBEngine"
                },
                "DBName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "db"
                        ]
                    ]
                },
                "EngineVersion": {
                    "Ref": "DBEngineVersion"
                },
                "MasterUsername": {
                    "Ref": "DBMasterUsername"
                },
                "MasterUserPassword": {
                    "Fn::Join": [
                        "",
                        [
                            "{{resolve:secretsmanager:",
                            {
                                "Ref": "SecretManager"
                            },
                            ":SecretString:password}}"
                        ]
                    ]
                },
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroupName"
                },
                "DBParameterGroupName": {
                    "Ref": "DBparametergroup"
                },
                "StorageEncrypted": true,
                "EnableCloudwatchLogsExports": [
                    "postgresql"
                ],
                "BackupRetentionPeriod": {
                    "Ref": "DBBackupRetentionPeriod"
                },
                "AutoMinorVersionUpgrade": false,
                "VPCSecurityGroups": [
                    {
                        "Ref": "BDSG"
                    }
                ],
                "KmsKeyId": {
                    "Ref": "DBKmsKeyId"
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-db"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f816e465-faad-4a19-857d-e20a74fd47b2"
                }
            }
        },
        "policy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks-restricted-policy"
                        ]
                    ]
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "ec2:DescribeInstances",
                                "ec2:DescribeSnapshots",
                                "elasticloadbalancing:DescribeLoadBalancerPolicies",
                                "elasticloadbalancing:DeleteLoadBalancerListeners",
                                "elasticloadbalancing:RegisterInstancesWithLoadBalancer",
                                "elasticloadbalancing:CreateLoadBalancerListeners",
                                "elasticloadbalancing:CreateLoadBalancer",
                                "elasticloadbalancing:ModifyTargetGroup",
                                "route53:AssociateVPCWithHostedZone",
                                "ec2:DescribeVolumes",
                                "ec2:DescribeAccountAttributes",
                                "logs:CreateLogGroup",
                                "iam:ListAttachedRolePolicies",
                                "ecr:BatchCheckLayerAvailability",
                                "ec2:DescribeNetworkInterfaces",
                                "ec2:DescribeDhcpOptions",
                                "elasticloadbalancing:ModifyLoadBalancerAttributes",
                                "ecr:GetDownloadUrlForLayer",
                                "ec2:DetachVolume",
                                "elasticloadbalancing:DescribeTargetGroups",
                                "ec2:DescribeAvailabilityZones",
                                "elasticloadbalancing:DescribeTargetGroupAttributes",
                                "elasticloadbalancing:DetachLoadBalancerFromSubnets",
                                "ec2:DescribeSubnets",
                                "elasticloadbalancing:DeleteLoadBalancer",
                                "elasticloadbalancing:CreateLoadBalancerPolicy",
                                "ecr:BatchGetImage",
                                "elasticloadbalancing:DeleteTargetGroup",
                                "elasticloadbalancing:SetLoadBalancerPoliciesOfListener",
                                "ecr:GetLifecyclePolicy",
                                "ec2:DeleteRoute",
                                "autoscaling:DescribeAutoScalingGroups",
                                "elasticloadbalancing:DeregisterTargets",
                                "elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer",
                                "elasticloadbalancing:ConfigureHealthCheck",
                                "elasticloadbalancing:ModifyTargetGroupAttributes",
                                "elasticloadbalancing:AttachLoadBalancerToSubnets",
                                "eks:UpdateClusterVersion",
                                "ecr:GetRepositoryPolicy",
                                "elasticloadbalancing:DeleteListener",
                                "ec2:DescribeRouteTables",
                                "ec2:AuthorizeSecurityGroupIngress",
                                "elasticloadbalancing:RegisterTargets",
                                "ec2:CreateTags",
                                "ec2:DetachNetworkInterface",
                                "ecr:DescribeImageScanFindings",
                                "logs:PutLogEvents",
                                "ecr:DescribeRepositories",
                                "ecr:DescribeImages",
                                "ecr:ListTagsForResource",
                                "ec2:ModifyVolume",
                                "ecr:ListImages",
                                "logs:DescribeLogStreams",
                                "ec2:DeleteTags",
                                "elasticloadbalancing:DescribeLoadBalancerAttributes",
                                "ec2:DescribeTags",
                                "elasticloadbalancing:CreateTargetGroup",
                                "ec2:DeleteSecurityGroup",
                                "ecr:GetLifecyclePolicyPreview",
                                "ec2:CreateNetworkInterface",
                                "ec2:DescribeInternetGateways",
                                "ec2:DescribeSecurityGroups",
                                "ec2:CreateRoute",
                                "elasticloadbalancing:DescribeLoadBalancers",
                                "ec2:DeleteVolume",
                                "kms:DescribeKey",
                                "ecr:GetAuthorizationToken",
                                "ec2:AttachNetworkInterface",
                                "elasticloadbalancing:CreateListener",
                                "elasticloadbalancing:ApplySecurityGroupsToLoadBalancer",
                                "ec2:ModifyNetworkInterfaceAttribute",
                                "elasticloadbalancing:DescribeTargetHealth",
                                "ec2:AttachVolume",
                                "elasticloadbalancing:AddTags",
                                "ec2:CreateVolume",
                                "ec2:UnassignPrivateIpAddresses",
                                "ec2:ModifyInstanceAttribute",
                                "ec2:CreateSnapshot",
                                "logs:CreateLogStream",
                                "ec2:RevokeSecurityGroupIngress",
                                "ec2:DescribeInstanceTypes",
                                "ec2:CreateSecurityGroup",
                                "ec2:DescribeVolumesModifications",
                                "ec2:DescribeInstanceAttribute",
                                "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",
                                "elasticloadbalancing:ModifyListener",
                                "ec2:DeleteNetworkInterface",
                                "ec2:AssignPrivateIpAddresses",
                                "ec2:DescribeVpcs",
                                "ec2:CreateNetworkInterfacePermission",
                                "autoscaling:UpdateAutoScalingGroup",
                                "ec2:DescribeAddresses",
                                "elasticloadbalancing:DescribeListeners",
                                "ec2:DescribeLaunchTemplateVersions",
                                "ec2:CreateLaunchTemplateVersion",
                                "ec2:CreateLaunchTemplate",
                                "ec2:DescribeLaunchTemplates",
                                "iam:PassRole",
                                "eks:CreateNodegroup",
                                "eks:DescribeCluster",
                                "eks:JoinNodeGroup"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "aws:PrincipalTag/Owner": {
                                        "Ref": "Owner"
                                    },
                                    "aws:PrincipalTag/Project": {
                                        "Ref": "Project"
                                    },
                                    "aws:PrincipalTag/Application": {
                                        "Ref": "Application"
                                    },
                                    "aws:PrincipalTag/Environment": {
                                        "Ref": "Environment"
                                    },
                                    "aws:PrincipalTag/SecondaryOwner": {
                                        "Ref": "SecondaryOwner"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "demo"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "6d973b60-12a0-4f91-a14e-ca9a92e718b3"
                }
            }
        },
        "sgeks": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks-sg"
                        ]
                    ]
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-eks-sg"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "VpcId"
                },
                "GroupDescription": "demo",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": {
                            "Ref": "EKSsgProtocol"
                        },
                        "FromPort": {
                            "Ref": "EKSsgFromport"
                        },
                        "ToPort": {
                            "Ref": "EKSsgToport"
                        },
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 9080,
                        "ToPort": 9080,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 9090,
                        "ToPort": 9090,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 4444,
                        "ToPort": 4444,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 9651,
                        "ToPort": 9651,
                        "CidrIp": {
                            "Ref": "EKSsgCIDR"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": 0,
                        "ToPort": 0,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "452dd6c1-e667-4127-9b56-1a72f4562630"
                }
            }
        },
        "EKSNG": {
            "Type": "AWS::EKS::Nodegroup",
            "Properties": {
                "ClusterName": {
                    "Ref": "EKS"
                },
                "NodegroupName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks-node-group"
                        ]
                    ]
                },
                "NodeRole": {
                    "Fn::GetAtt": [
                        "demo",
                        "Arn"
                    ]
                },
                "Subnets": {
                    "Ref": "subneteks"
                },
                "CapacityType": {
                    "Ref": "NGCapacityType"
                },
                "ScalingConfig": {
                    "MinSize": {
                        "Ref": "NGMinSize"
                    },
                    "DesiredSize": {
                        "Ref": "NGDesiredSize"
                    },
                    "MaxSize": {
                        "Ref": "NGMaxSize"
                    }
                },
                "InstanceTypes": {
                    "Ref": "NGInstanceTypes"
                },
                "LaunchTemplate": {
                    "Id": {
                        "Ref": "launchtemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "launchtemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "Tags": {
                    "Owner": {
                        "Ref": "Owner"
                    },
                    "Project": {
                        "Ref": "Project"
                    },
                    "Name": {
                        "Fn::Join": [
                            "",
                            [
                                {
                                    "Ref": "Name"
                                },
                                "-eks-node-group"
                            ]
                        ]
                    },
                    "Application": {
                        "Ref": "Application"
                    },
                    "Environment": {
                        "Ref": "Environment"
                    },
                    "SecondaryOwner": {
                        "Ref": "SecondaryOwner"
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "3b9ca79b-ce3c-4ec3-a149-cecf0005bf79"
                }
            }
        },
        "EKSADDON": {
            "Type": "AWS::EKS::Addon",
            "Properties": {
                "AddonName": "aws-ebs-csi-driver",
                "AddonVersion": "v1.25.0-eksbuild.1",
                "ClusterName": {
                    "Ref": "EKS"
                },
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "Project"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "Name"
                                    },
                                    "-eks-addon"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "Application"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecondaryOwner",
                        "Value": {
                            "Ref": "SecondaryOwner"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8c966e8a-4636-47d1-80f1-b7a9e928c244"
                }
            },
            "DependsOn": [
                "EKSNG"
            ]
        },
        "launchtemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "Name"
                            },
                            "-eks-template"
                        ]
                    ]
                },
                "LaunchTemplateData": {
                    "ImageId": {
                        "Ref": "Imageid"
                    },
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "MIME-Version: 1.0\nContent-Type: multipart/mixed; boundary=\"//\"\n--//\nContent-Type: text/x-shellscript; charset=\"us-ascii\"\n#!/bin/bash\nset -ex\nB64_CLUSTER_CA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJUTI1WnQ4cTRTcnN3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRBME1ETXhNRFV3TkRGYUZ3MHpOREEwTURFeE1EVTFOREZhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURWd2JPeFphMVM0bCthMHc3cWNDN3FXOEpyVDliODhHeUoxNG9sSDdqMnExY0xJb0VRQjZlaXBBa2IKL1VMWk5WZmU4d3IxNlJoQ1UyYUR1M2Frd0EzN09SdHB0b3B2UGt4NnVCK0hoZUhqczg3YXJKTTROWTVwK2R2VAphd3Zla2NqMGpLbjJnZ2hWOFVmVGk1M0lpUFBYQVc1ZWNqbjRrd1hFTDAzK2NtUlMxNGhXcmYwWWluMXZCTFJUCmhZOG9YbWRVOFFzbDk0L0FCUTFZd0YrY3B5Sm1nMUhMeDFsTE1rSmVqN2ZzTEdCTlZ5T2wzNTlDZGxyQnQwTEgKS3llc0IzbEd3TmY2djFkckZNd2NOSC8zSzRhQjhwRVV0bmtrdHN3dUllV25TT1p0d2FzR21BUmUvM2lVakM2MApPSGszNG04ak1EUDFhMnpMUjQ2d3pKd3Z3Mk9UQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJSS2RXZFYzdHRmOWlOVnlRd1VZMEFHSk5GT1RUQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUx4REtCUWp1aQpCdEN0ZERaUENSRHhvaUx2OTVlK1FNU0p2aFIyZUU0bWlvRFVEd2Z5RFdhU2REUFhFeE1hdHE1RlR3czZVdndjCnp2YTYzY3dMVzZtczZIaFVxVFZCRHNZM3VOZ2lvdG1XbFVxbHZlUHAwVHVndXVHeUFKSjVlUW9vSUc5YnRPeDAKNmJPVStjbHg3UXlpbFJnL1ZCN0ZJVURMUTVSaERxcVZud0tjditCZW5GckRQUUd2bktDRjVvbnRrN3haYldqdQpoQ0tJdkNqem56bDE5dDF0MUgyd0FTTm9oano5ZG54ejlYQ3lVcE1XQkdXVkNOa2UzdnRqQUpWd054ZkpUZDJ6ClpWc1l4cW1lUHBvdi8xQURyNmg4Q0lCRnRTYkVEYlVoVXc1WnZJYnFzbkZIOHBTc2FrankvOExNVjBDWkh6T1UKWldCS3BTdFlzQ1czCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K\nAPI_SERVER_URL=https://41714E698A8EC6E3A0EA54A72E8908E5.gr7.ap-southeast-2.eks.amazonaws.com\nK8S_CLUSTER_DNS_IP=10.100.0.10\n/etc/eks/bootstrap.sh eks-stack-eks --kubelet-extra-args '--max-pods=17' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP --use-max-pods false\n--//--\n"
                        }
                    },
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Owner",
                                    "Value": {
                                        "Ref": "Owner"
                                    }
                                },
                                {
                                    "Key": "Project",
                                    "Value": {
                                        "Ref": "Project"
                                    }
                                },
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                {
                                                    "Ref": "Name"
                                                },
                                                "-eks-node"
                                            ]
                                        ]
                                    }
                                },
                                {
                                    "Key": "Application",
                                    "Value": {
                                        "Ref": "Application"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "Environment"
                                    }
                                },
                                {
                                    "Key": "SecondaryOwner",
                                    "Value": {
                                        "Ref": "SecondaryOwner"
                                    }
                                }
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "af29e948-a0c3-450a-aaf2-a491926ed7e7"
                }
            }
        }
    }
}